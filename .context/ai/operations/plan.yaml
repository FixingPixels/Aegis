# Plan Operation Pattern
version: 1.0
command: plan
description: Create or update project planning document and initial tasks

# Operation Flow
flow:
  pre_checks:
    - framework_ready: {verify: framework_check, error: "Framework not ready"}
  
  steps:
    1_check_planning:
      action: check_document
      file: planning_document.md
      create_if_missing: true
      template: planning_template
    
    2_load_context:
      action: load_context
      files:
        - current_state: {path: "current_state.md", required: false}
        - roadmap: {path: "roadmap.md", required: false}
    
    3_process_plan:
      action: process_planning
      analyze:
        - existing_plan: {if_exists: "planning_document.md"}
        - current_state: {if_exists: "current_state.md"}
        - roadmap: {if_exists: "roadmap.md"}
    
    4_guide_planning:
      action: guide_planning
      steps:
        - project_goals: {prompt: true, required: true}
        - technical_approach: {prompt: true, required: true}
        - implementation: {prompt: true, required: true}
        - timeline: {prompt: true, required: true}
    
    5_create_tasks:
      action: create_initial_tasks
      source: planning_document.md
      target: tasks/planned
      template: tasks/TEMPLATE.md
      process:
        - read_implementation_section
        - for_each_phase:
          - create_task_file:
            title: from_phase_name
            description: from_phase_content
            status: planned
            priority: from_timeline_position
            id: sequential_number
        - update_references:
          - link_dependencies
          - set_memory_types

# Validation Rules
validation:
  planning_doc:
    format: markdown
    sections: [goals, approach, implementation, timeline]
    validate: [structure, completeness]
  
  context_files:
    optional: [current_state.md, roadmap.md]
    check: [exists, readable]
  
  task_creation:
    required_fields: [id, title, status, priority, description]
    validate: [format, dependencies]
    status: planned

# Error Handling
errors:
  not_ready:
    msg: "Framework not ready"
    action: show_setup_instructions
    help: "Copy .context directory to your project and ensure all required files exist"
  
  invalid_plan:
    msg: "Invalid planning document"
    action: show_template
    help: "Follow planning document template"
  
  task_creation_failed:
    msg: "Failed to create tasks"
    action: show_task_errors
    help: "Check task template and planning document structure"

# Templates
templates:
  planning:
    file: planning_document.md
    sections:
      - goals: "Project Goals and Requirements"
      - approach: "Technical Approach"
      - implementation: "Implementation Plan"
      - timeline: "Timeline and Milestones"
  
  task_creation:
    naming: "${number}_${phase_name}"
    content:
      - copy_template
      - replace_variables:
        - title: phase_name
        - description: phase_content
        - status: "planned"
        - created: current_date
        - updated: current_date
        - id: "TASK-${number}"

# Important Notes
notes:
  usage:
    - entry_point: "Can be used as first command"
    - prerequisites: "Only needs .context structure"
    - state: "Will create initial state if needed"
    - tasks: "Creates initial planned tasks"
  
  task_creation:
    - uses_template: "Based on TEMPLATE.md"
    - text_only: "No programming required"
    - sequential: "Creates tasks in phase order"
    - maintains_refs: "Updates task references" 